<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ระบบคลังโครงงาน (v5 - Student ID Added)</title>
<style>
body{ margin:0; font-family: 'Prompt', sans-serif; background:#f0f2f5; color: #333; }
.page{ display:none; padding:20px; box-sizing: border-box; }
.center-box{ width:350px; background:white; padding:25px; margin:80px auto; border-radius:15px; box-shadow:0 8px 25px rgba(0,0,0,.2); text-align:center; }
.form-box{ width:100%; max-width:800px; margin:auto; background:white; padding:30px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,.15); }
input, select { width:100%; padding:12px; margin:8px 0; border-radius:10px; border:1px solid #ddd; box-sizing: border-box; font-size: 16px; }
button { width:100%; padding:12px; margin-top:10px; border:none; border-radius:10px; font-size:17px; background:linear-gradient(135deg,#2575fc,#6a11cb); color:white; cursor:pointer; transition: 0.3s; }
button:hover { opacity: 0.9; transform: translateY(-1px); }

/* ปรับปรุงส่วน Input ผู้จัดทำ */
.author-row { display: flex; gap: 10px; margin-bottom: 5px; }
.author-row input:first-child { flex: 2; } /* ชื่อยาวกว่า */
.author-row input:last-child { flex: 1; }  /* เลขประจำตัวสั้นกว่า */

.project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
.project-box { position:relative; border:1px solid #eee; border-radius:12px; padding:20px; background:#fff; transition: 0.3s; }
.project-box:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
.project-title { font-size:18px; font-weight:bold; color:#6a11cb; margin-bottom:10px; line-height: 1.4; }
.tag { display: inline-block; padding: 4px 10px; background: #e8f0fe; color: #1a73e8; border-radius: 20px; font-size: 11px; margin-top: 5px; margin-right: 5px; }
.tag-subject { background: #fff3e0; color: #e65100; }
.action-btns { position:absolute; top:10px; right:10px; display: flex; gap: 5px; }
.mini-btn { width:28px; height:28px; border-radius:50%; border:none; color:white; cursor:pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
.delete-btn { background:#ff4d4f; }
.edit-btn { background:#f39c12; }
.sub-title { font-weight:bold; margin-top:12px; margin-bottom:5px; font-size: 14px; color: #555; }
.search-container { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
.search-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
.search-row input { flex: 2; min-width: 200px; }
.search-row select { flex: 1; min-width: 150px; }
</style>
</head>
<body>

<div id="page-login" class="page" style="display:block;">
    <div class="center-box">
        <h2>เข้าสู่ระบบ</h2>
        <input id="loginUser" placeholder="ชื่อผู้ใช้">
        <input id="loginPass" type="password" placeholder="รหัสผ่าน">
        <button onclick="login()">เข้าสู่ระบบ</button>
    </div>
</div>

<div id="page-choice" class="page">
    <div class="center-box">
        <h2 id="welcomeText">ยินดีต้อนรับ</h2>
        <button onclick="enterCreator()"> จัดการโครงงานของฉัน</button>
        <button onclick="enterViewer()" style="background: #00b894;"> ดูโครงงานทั้งหมด</button>
        <button style="background: #636e72;" onclick="logout()">ออกจากระบบ</button>
    </div>
</div>

<div id="page-form" class="page">
    <div class="form-box">
        <h2 id="formTitle" style="text-align:center;">บันทึกข้อมูลโครงงาน</h2>
        <input type="hidden" id="editId">
       
        <div class="sub-title">ชื่อโครงงาน</div>
        <input id="pth" placeholder="ชื่อภาษาไทย *">
        <input id="pen" placeholder="ชื่อภาษาอังกฤษ">
       
        <div class="sub-title">ผู้จัดทำ (ชื่อ-นามสกุล และ เลขประจำตัว)</div>
        <div class="author-row">
            <input id="f1" placeholder="ชื่อคนที่ 1 *">
            <input id="id1" placeholder="เลขประจำตัว *">
        </div>
        <div class="author-row">
            <input id="f2" placeholder="ชื่อคนที่ 2">
            <input id="id2" placeholder="เลขประจำตัว">
        </div>
        <div class="author-row">
            <input id="f3" placeholder="ชื่อคนที่ 3">
            <input id="id3" placeholder="เลขประจำตัว">
        </div>
       
        <div class="sub-title">ครูที่ปรึกษา</div>
        <input id="t1" placeholder="ชื่อครูที่ปรึกษา">
       
        <div class="sub-title">หมวดหมู่</div>
        <select id="cat">
            <option value="">-- เลือก Theme --</option>
        </select>
        <select id="subject">
            <option value="">-- เลือกหมวดหมู่วิชา --</option>
        </select>
       
        <div class="sub-title">ไฟล์รูปเล่ม (หากแก้ไขและไม่เลือกใหม่ จะใช้ไฟล์เดิม)</div>
        <input type="file" id="projectFile">
       
        <button id="btnSave" onclick="saveData()"> บันทึกข้อมูล</button>
        <button style="background:#888" onclick="enterCreator()">ยกเลิก</button>
    </div>
</div>

<div id="page-result" class="page">
    <div class="form-box" style="max-width: 900px;">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <h2>โครงงานของฉัน</h2>
            <button onclick="show('page-choice')" style="width: auto; padding: 8px 20px;">กลับ</button>
        </div>
        <div id="my-projects" class="project-grid"></div>
        <button onclick="addProject()" style="background:none; color:#6a11cb; border:2px dashed #6a11cb; margin-top:20px;">+ เพิ่มโครงงานใหม่</button>
    </div>
</div>

<div id="page-viewer" class="page">
    <div class="form-box" style="max-width: 1000px; background: transparent; box-shadow: none; padding: 0;">
        <div style="display:flex; justify-content: space-between; align-items: center; background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
            <h2 style="margin:0;">คลังโครงงานทั้งหมด</h2>
            <button onclick="show('page-choice')" style="width: auto; padding: 8px 20px;">หน้าหลัก</button>
        </div>
        <div class="search-container">
            <div class="search-row"><input id="searchInp" placeholder="ค้นหาชื่อ, ผู้จัดทำ หรือเลขประจำตัว..." oninput="filterProjects()"></div>
            <div class="search-row">
                <select id="searchCat" onchange="filterProjects()"><option value="">ทุก Theme</option></select>
                <select id="searchSub" onchange="filterProjects()"><option value="">ทุกวิชา</option></select>
            </div>
        </div>
        <div id="all-projects-grid" class="project-grid"></div>
    </div>
</div>

<script>
let currentUser = "";
const THEMES = ["1. การเกษตรและการแปรรูป","2. การท่องเที่ยวคุณภาพ","3. ยานยนต์ไฟฟ้า","4. การแพทย์และสุขภาพ","5. โลจิสติกส์","6. อุปกรณ์อิเล็กทรอนิกส์อัจฉริยะ","7. SME คุณภาพสูง","8. พื้นที่และเมืองอัจฉริยะ","9. ความยากจนและการคุ้มครองทางสังคม","10. เศรษฐกิจหมุนเวียน","11. การเปลี่ยนแปลงสภาพภูมิอากาศ","12. กำลังคนสมรรถนะสูง","13. ภาครัฐที่ทันสมัย"];
const SUBJECTS = ["ฟิสิกส์","เคมี","ชีววิทยาและวิทยาศาสตร์สุขภาพ","คณิตศาสตร์และวิทยาการคำนวณ","ภาษาต่างประเทศ","ศิลปศาสตร์"];

function initSelects() {
    const cat = document.getElementById("cat");
    const sub = document.getElementById("subject");
    if(cat.options.length <= 1) THEMES.forEach(t => cat.add(new Option(t, t)));
    if(sub.options.length <= 1) SUBJECTS.forEach(s => sub.add(new Option(s, s)));
}

function show(id) {
    document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
    document.getElementById(id).style.display = 'block';
    if(id === 'page-form') initSelects();
}

function login() {
    const u = document.getElementById("loginUser").value.trim();
    if(u) { currentUser = u; localStorage.setItem("lastUser", u); show('page-choice'); document.getElementById("welcomeText").innerText = "สวัสดีคุณ " + u; }
}

function logout() { localStorage.removeItem("lastUser"); location.reload(); }
function enterCreator() { renderMyProjects(); show('page-result'); }
function addProject() { resetForm(); document.getElementById("formTitle").innerText = "เพิ่มโครงงานใหม่"; show('page-form'); }

// แก้ไขฟังก์ชัน saveData
function saveData() {
    const pth = document.getElementById("pth").value;
    const f1 = document.getElementById("f1").value;
    const id1 = document.getElementById("id1").value;
    const editId = document.getElementById("editId").value;
    const fileInp = document.getElementById("projectFile");

    if(!pth || !f1 || !id1) return alert("กรุณากรอกชื่อโครงงาน ชื่อผู้จัดทำ และเลขประจำตัวคนที่ 1");

    if(fileInp.files[0]) {
        // ตรวจสอบขนาดไฟล์ก่อน (สมมติไม่เกิน 2MB เพื่อความปลอดภัยของ LocalStorage)
        if (fileInp.files[0].size > 2 * 1024 * 1024) {
            return alert("ไฟล์มีขนาดใหญ่เกินไป (จำกัดไม่เกิน 2MB สำหรับระบบจำลองนี้)");
        }
        
        const reader = new FileReader();
        reader.onload = (e) => { 
            finalizeSave(e.target.result, fileInp.files[0].name, editId); 
        };
        reader.readAsDataURL(fileInp.files[0]);
    } else {
        let oldFile = null, oldFileName = null;
        if(editId) {
            let all = JSON.parse(localStorage.getItem("all_projects_db")) || [];
            let oldData = all.find(x => x.id == editId);
            if(oldData) { oldFile = oldData.file; oldFileName = oldData.fileName; }
        }
        finalizeSave(oldFile, oldFileName, editId);
    }
}

// แก้ไขฟังก์ชัน finalizeSave ให้มีการ Try-Catch
function finalizeSave(fileData, fileName, editId) {
    try {
        let all = JSON.parse(localStorage.getItem("all_projects_db")) || [];
        
        const data = {
            id: editId ? parseInt(editId) : Date.now(),
            owner: currentUser,
            pth: document.getElementById("pth").value,
            pen: document.getElementById("pen").value,
            cat: document.getElementById("cat").value,
            sub: document.getElementById("subject").value,
            s1: document.getElementById("f1").value,
            id1: document.getElementById("id1").value,
            s2: document.getElementById("f2").value,
            id2: document.getElementById("id2").value,
            s3: document.getElementById("f3").value,
            id3: document.getElementById("id3").value,
            t1: document.getElementById("t1").value,
            file: fileData,
            fileName: fileName
        };

        if(editId) {
            const index = all.findIndex(x => x.id == editId);
            all[index] = data;
        } else {
            all.push(data);
        }

        localStorage.setItem("all_projects_db", JSON.stringify(all));
        alert(editId ? "แก้ไขข้อมูลเรียบร้อย!" : "บันทึกเรียบร้อย!");
        enterCreator();
    } catch (e) {
        console.error(e);
        if (e.name === 'QuotaExceededError') {
            alert("พื้นที่จัดเก็บเต็ม! ไม่สามารถบันทึกไฟล์ขนาดใหญ่นี้ได้ กรุณาลบโครงงานเก่าออกหรือใช้ไฟล์ที่เล็กลง");
        } else {
            alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล");
        }
    }
}

function renderMyProjects() {
    const all = JSON.parse(localStorage.getItem("all_projects_db")) || [];
    const my = all.filter(p => p.owner === currentUser);
    document.getElementById("my-projects").innerHTML = my.map(p => createCard(p, true)).join('');
}

function editProj(id) {
    const all = JSON.parse(localStorage.getItem("all_projects_db")) || [];
    const p = all.find(x => x.id === id);
    if(!p) return;

    show('page-form');
    document.getElementById("formTitle").innerText = "แก้ไขข้อมูลโครงงาน";
    document.getElementById("editId").value = p.id;
    document.getElementById("pth").value = p.pth;
    document.getElementById("pen").value = p.pen || "";
    document.getElementById("f1").value = p.s1 || "";
    document.getElementById("id1").value = p.id1 || "";
    document.getElementById("f2").value = p.s2 || "";
    document.getElementById("id2").value = p.id2 || "";
    document.getElementById("f3").value = p.s3 || "";
    document.getElementById("id3").value = p.id3 || "";
    document.getElementById("t1").value = p.t1 || "";
    document.getElementById("cat").value = p.cat || "";
    document.getElementById("subject").value = p.sub || "";
}

function enterViewer() {
    show('page-viewer');
    const cSel = document.getElementById("searchCat");
    const sSel = document.getElementById("searchSub");
    if(cSel.options.length <= 1) THEMES.forEach(t => cSel.add(new Option(t, t)));
    if(sSel.options.length <= 1) SUBJECTS.forEach(s => sSel.add(new Option(s, s)));
    filterProjects();
}

function filterProjects() {
    const kw = document.getElementById("searchInp").value.toLowerCase();
    const cat = document.getElementById("searchCat").value;
    const sub = document.getElementById("searchSub").value;
    const all = JSON.parse(localStorage.getItem("all_projects_db")) || [];
   
    const filtered = all.filter(p => {
        const matchText = (p.pth + (p.s1||"") + (p.id1||"") + (p.s2||"") + (p.id2||"") + (p.s3||"") + (p.id3||"")).toLowerCase().includes(kw);
        const matchCat = !cat || p.cat === cat;
        const matchSub = !sub || p.sub === sub;
        return matchText && matchCat && matchSub;
    });
    document.getElementById("all-projects-grid").innerHTML = filtered.map(p => createCard(p, false)).join('');
}

function createCard(p, isOwner) {
    // จัดรูปแบบการแสดงผลชื่อ + เลขประจำตัว
    let authors = [];
    if(p.s1) authors.push(`${p.s1} (${p.id1 || '-'})`);
    if(p.s2) authors.push(`${p.s2} (${p.id2 || '-'})`);
    if(p.s3) authors.push(`${p.s3} (${p.id3 || '-'})`);

    return `
        <div class="project-box">
            ${isOwner ? `
                <div class="action-btns">
                    <button class="mini-btn edit-btn" onclick="editProj(${p.id})">✎</button>
                    <button class="mini-btn delete-btn" onclick="deleteProj(${p.id})">✕</button>
                </div>
            ` : ''}
            <div class="project-title">${p.pth}</div>
            <div class="tag">${p.cat || 'ไม่มี Theme'}</div>
            <div class="tag tag-subject">${p.sub || 'ไม่มีหมวดวิชา'}</div>
            <div class="sub-title" style="color:#666;">โดย: <br>${authors.join('<br>')}</div>
            ${p.file ? `<button onclick="handleDownload(${p.id})" style="background:#0984e3; margin-top:15px;"> ดาวน์โหลดไฟล์</button>` : '<p style="font-size:12px;color:#999;margin-top:10px;">ไม่มีไฟล์แนบ</p>'}
        </div>
    `;
}

function handleDownload(id) {
    const all = JSON.parse(localStorage.getItem("all_projects_db")) || [];
    const p = all.find(x => x.id === id);
    if (!p || !p.file) return alert("ไม่พบข้อมูลไฟล์");
    const link = document.createElement('a');
    link.href = p.file;
    link.download = p.fileName || "โครงงาน.pdf";
    document.body.appendChild(link);
    link.click();
    setTimeout(() => document.body.removeChild(link), 100);
}

function deleteProj(id) {
    if(confirm("ยืนยันการลบโครงงานนี้?")) {
        let all = JSON.parse(localStorage.getItem("all_projects_db")) || [];
        localStorage.setItem("all_projects_db", JSON.stringify(all.filter(x => x.id !== id)));
        renderMyProjects();
    }
}

function resetForm() {
    document.getElementById("editId").value = "";
    document.querySelectorAll('#page-form input').forEach(i => i.value='');
    document.getElementById("cat").value = "";
    document.getElementById("subject").value = "";
}

window.onload = () => {
    const last = localStorage.getItem("lastUser");
    if(last) { currentUser = last; show('page-choice'); document.getElementById("welcomeText").innerText = "สวัสดีคุณ " + last; }
};
</script>
</body>
</html>